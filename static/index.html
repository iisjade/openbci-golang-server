<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
		<script type="text/javascript">
			if (window["WebSocket"]) {
				conn = new WebSocket("ws://{{$}}/ws");
				conn.onclose = function(evt) {
					console.log("closing")
				}
				conn.onmessage = function(evt) {
					data = JSON.parse(evt.data)
					console.log("received data:", data.Chans.Chan1)
				}
				conn.onopen = function(evt) {
					console.log("opening")
				}
			} else {
				appendLog($("<div><b>Your browser does not support WebSockets.</b></div>"))
			}
		</script>
		<script type="text/javascript">
			jQuery(document).ready(function() {
				jQuery("#streamcommands :input").click(function() {
					var postURL = $(this).attr('href');
					jQuery.ajax({	type:"POST",
												url:postURL
											});
				});

				jQuery("#chantoggle :input").click(function() {
					var postURL = $(this).attr('href') + 
												$(this).attr('value') + '/' + 
												$(this).is(':checked');
					jQuery.ajax({	type:"POST",
												url:postURL
											});
				});

				jQuery("#complexcommands #update").click(function() {
					var chan = $("form#longcommand #channel").val()
					var postURL = $(this).attr('href') + chan + "/x" + chan +
												$("form#longcommand #power").val() +
												$("form#longcommand #gain").val() +
												$("form#longcommand #input").val() +
												$("form#longcommand #bias").val() +
												$("form#longcommand #srb2").val() +
												$("form#longcommand #srb1").val() +
												"X"
					jQuery.ajax({	type:"POST",
												url:postURL
											});
				});

			});
		</script>
	</head>

	<body>
		
		<canvas id="canvas" width="400" height="300">
		
		</canvas>
		
		<script id="vertShader" type="x-shader/x-vertex">
			uniform mat4 modelViewMat;
			uniform mat4 projMat;
			
			attribute vec3 pos;
			
			varying vec4 worldPos;
			void main() {
				worldPos = modelViewMat * vec4(pos, 1);
				gl_Position = projMat*worldPos;
			}
			
		</script>
		
		<script id="fragShader" type="x-shader/x-fragment">
			
			varying mediump vec4 worldPos;
			
			void main() {
				gl_FragColor = vec4(1.0 - worldPos.y, worldPos.y, 0.0, 1.0);
			}
		</script>
		
		<script src="http://localhost:8888/js/webgl-debug.js"></script>
		
		<script type="text/javascript">
			var canvas = document.getElementById('canvas');
			var gl = canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
			gl = WebGLDebugUtils.makeDebugContext(gl);
			var vbo;
			var vertArray;
			
			var transpose = function(a) {
				var t = [];
				for (var i = 0; i < 16; ++i) {
					t[i] = a[(4*i + Math.floor(i/4)) % 16];
				}
				return t;
			};
			
			var toFloat32Array = function(a) {
				var f32a = new Float32Array(a.length);
				a.forEach(function(f, i) {
					f32a[i] = f;
				});
				return f32a;
			}

			var scope = {
				getContext: function()  {
					return gl; 
				},
				
				init: function(channels, historyLength) {
					var numVerts = channels*historyLength;
					vertArray = new Float32Array(numVerts * 3);
					vbo = gl.createBuffer();
					gl.bindBuffer(gl.ARRAY_BUFFER, vbo);
					gl.bufferData(gl.ARRAY_BUFFER, numVerts * vertArray.BYTES_PER_ELEMENT * 3, gl.DYNAMIC_DRAW);
					gl.bufferData(gl.ARRAY_BUFFER, vertArray.buffer, gl.DYNAMIC_DRAW);
					
					var vertSrc = document.getElementById('vertShader').text;
					var fragSrc = document.getElementById('fragShader').text;
					
					var program = scope.buildShaderProgram(vertSrc, fragSrc);
					var posIndex = gl.getAttribLocation(program, "pos");
					gl.vertexAttribPointer(posIndex, 3, gl.FLOAT, gl.FALSE, vertArray.BYTES_PER_ELEMENT * 3, 0);
					var modelViewMatLoc = gl.getUniformLocation(program, 'modelViewMat');
					var projMatLoc = gl.getUniformLocation(program, 'projMat');
					gl.useProgram(program);
					var idenMat = new Float32Array(16);
					idenMat[0] = idenMat[5] = idenMat[10] = idenMat[15] = 1;
					var n = 0.01, f = 1000;
					var b = -1, t = 1;
					var l = -1, r = 1;
					var projMat = toFloat32Array(transpose([
						2*n/(r-l), 0,         (r+l)/(r-l),  0,
						0,         2*n/(t-b), (t+b)/(t-b),  0,
						0,         0,         (-n-f)/(f-n), -2*f*n/(f-n),
						0,         0,         -1,           0,
					]));
					
					
					gl.uniformMatrix4fv(modelViewMatLoc, gl.FALSE, idenMat);
					gl.uniformMatrix4fv(projMatLoc, gl.FALSE, projMat);
					
					gl.useProgram(program);
				},
				
				buildShaderProgram: function(vertSrc, fragSrc) {
					var vertShader = gl.createShader(gl.VERTEX_SHADER);
					var fragShader = gl.createShader(gl.FRAGMENT_SHADER);
					gl.shaderSource(vertShader, vertSrc);
					gl.shaderSource(fragShader, fragSrc);
					gl.compileShader(vertShader);
					console.log("vertex shader compilation log:\n",
					gl.getShaderInfoLog(vertShader));
					gl.compileShader(fragShader);
					console.log("fragment shader compilation log:\n",
					gl.getShaderInfoLog(fragShader));
					
					var program = gl.createProgram();
					gl.attachShader(program, vertShader);
					gl.attachShader(program, fragShader);
					
					gl.linkProgram(program);
					
					console.log("linker log:\n",
					gl.getProgramInfoLog(program));
					return program;
				},
				
				getError: function() {
					return gl.getError();
				},
			};
			window.bciVis = scope;

		</script>

		<div id="streamcommands" align="center">
			<input type="button" value="open" href="http://{{$}}/open">
			<input type="button" value="reset" href="http://{{$}}/reset">
			<input type="button" value="start" href="http://{{$}}/start">
			<input type="button" value="stop" href="http://{{$}}/stop">
			<input type="button" value="close" href="http://{{$}}/close">
			<input type="button" value="gentest" href="http://{{$}}/test">
		</div>

		<div id="chantoggle" align="left"><br>
			<input type="checkbox" value="1" href="http://{{$}}/x/" checked>Channel 1<br> 
			<input type="checkbox" value="2" href="http://{{$}}/x/" checked>Channel 2<br>
			<input type="checkbox" value="3" href="http://{{$}}/x/" checked>Channel 3<br>
			<input type="checkbox" value="4" href="http://{{$}}/x/" checked>Channel 4<br>
			<input type="checkbox" value="5" href="http://{{$}}/x/" checked>Channel 5<br>
			<input type="checkbox" value="6" href="http://{{$}}/x/" checked>Channel 6<br>
			<input type="checkbox" value="7" href="http://{{$}}/x/" checked>Channel 7<br>
			<input type="checkbox" value="8" href="http://{{$}}/x/" checked>Channel 8<br>
		<br>
		</div>

		<div id="complexcommands" align="left">
			<form id="longcommand">
				<input type="button" id="update" value="update" href="http://{{$}}/x/">

				<select id="channel">
					<option value="0">All Channels</option>
					<option value="1">Channel 1</option>
					<option value="2">Channel 2</option>
					<option value="3">Channel 3</option>
					<option value="4">Channel 4</option>
					<option value="5">Channel 5</option>
					<option value="6">Channel 6</option>
					<option value="7">Channel 7</option>
					<option value="8">Channel 8</option>
				</select>

				<select id="power">
					<option value="0">Power On</option>
					<option value="1">Power Off</option>
				</select>

				<select id="gain">
					<option value="6">24x gain</option>
					<option value="5">12x gain</option>
					<option value="4">8x gain</option>
					<option value="3">6x gain</option>
					<option value="2">4x gain</option>
					<option value="1">2x gain</option>
					<option value="0">1x gain</option>
				</select>

				<select id="input">
					<option value="0">Normal</option>
					<option value="1">Shorted</option>
					<option value="2">Bias meas</option>
					<option value="3">MVDD</option>
					<option value="4">Temp</option>
					<option value="5">Test signal</option>
					<option value="6">Bias DRP</option>
					<option value="7">Bias DRN</option>
				</select>

				<select id="bias">
					<option value="1">Include in BIAS</option>
					<option value="0">Exclude from BIAS</option>
				</select>

				<select id="srb2">
					<option value="1">Connect SRB2</option>
					<option value="0">Disconn SRB2</option>
				</select>

				<select id="srb1">
					<option value="0">Disconn SRB1</option>
					<option value="1">Connect SRB1</option>
				</select>
			</form>
		</div>
	</body>
</html>
